name: PR CI - ASP.NET Core WebApp

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'  # æ ¹æ“šä½ ä½¿ç”¨çš„ .NET ç‰ˆæœ¬èª¿æ•´

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release
        
      - name: Get PR Diff
        id: diff
        run: |
          echo "Getting diff for PR #${{ github.event.pull_request.number }}"
          git fetch origin main
          git diff origin/main > diff.txt
      
      - name: Call OpenAI for Review
        id: openai_review
        run: |
          echo "Calling OpenAI API to analyze code diff..."
      
          DIFF_CONTENT=$(cat diff.txt | head -c 6000 | jq -Rs .)
      
          REQUEST_DATA=$(jq -n \
            --arg model "gpt-4o" \
            --arg system_msg "ä½ æ˜¯ä¸€ä½è³‡æ·±ç¨‹å¼ç¢¼å¯©æŸ¥å“¡ï¼Œå°ˆé•·åœ¨æ–¼æ‰¾å‡ºæŠ€è¡“å‚µã€é‡æ§‹å»ºè­°èˆ‡ clean code å’Œ SOLID åŸå‰‡ã€‚" \
            --arg user_msg "ä»¥ä¸‹æ˜¯ pull request çš„ç¨‹å¼ç¢¼å·®ç•°ï¼Œè«‹æŒ‡å‡ºæ˜¯å¦æœ‰æŠ€è¡“å‚µã€å£å‘³é“ã€ç¶­è­·é¢¨éšªã€å®‰å…¨æ€§å•é¡Œï¼Œä¸¦çµ¦å‡ºé‡æ§‹å»ºè­°ï¼š\n\n$(cat diff.txt | head -c 6000)" \
            '{
              model: $model,
              temperature: 0.7,
              messages: [
                { role: "system", content: $system_msg },
                { role: "user", content: $user_msg }
              ]
            }')
      
          echo "ğŸŸ¡ Sending this request to OpenAI:"
          echo "$REQUEST_DATA" | jq .
      
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d "$REQUEST_DATA")
      
          echo "ğŸŸ¢ OpenAI å›æ‡‰å…§å®¹ï¼š"
          echo "$RESPONSE" | jq .
      
          echo "$RESPONSE" | jq -r '.choices[0].message.content' > review.txt

          REVIEW_CONTENT=$(cat review.txt | perl -pe 's/\\n/\n/g')
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ğŸ¤– **AI ç¨‹å¼ç¢¼å¯©æŸ¥æ„è¦‹**
            
            ä»¥ä¸‹æ˜¯ OpenAI GPT-4o å°æ­¤ PR çš„åˆ†æèˆ‡å»ºè­°ï¼š

            ${{ steps.openai_review.outputs.review }}

      - name: Run tests
        run: dotnet test --no-build --configuration Release --logger "trx"
